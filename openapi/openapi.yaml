openapi: 3.0.3
info:
  title: URL Shortener API
  version: "1.0.0"
  description: URL shortener service API.

servers:
  - url: http://localhost:8080
  - url: https://example.com

paths:
  /ping:
    get:
      summary: Healthcheck
      description: Returns pong.
      tags: [health]
      responses:
        "200":
          description: OK
          content:
            text/plain:
              schema:
                type: string
                example: pong
        "499":
          $ref: "#/components/responses/RequestCanceled"
        "504":
          $ref: "#/components/responses/GatewayTimeout"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/links:
    get:
      summary: List links
      description: |
        Returns all links when range is not provided.
        When range is provided, returns a page and includes Content-Range.
      tags: [links]
      parameters:
        - name: range
          in: query
          description: Range of items, format [start,count].
          required: false
          schema:
            type: string
            example: "[0,10]"
        - name: Range
          in: header
          description: Range of items, format links=start-count.
          required: false
          schema:
            type: string
            example: "links=0-9"
        - name: sort
          in: query
          description: |
            Sort order as JSON [field,ASC|DESC].
            Allowed fields: id, short_name, original_url.
            Alias: short_url -> short_name.
          required: false
          schema:
            type: string
            example: '["id","DESC"]'
      responses:
        "200":
          description: OK
          headers:
            Content-Range:
              description: Range metadata when range is provided.
              schema:
                type: string
                example: "links 0-9/42"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/LinkResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "499":
          $ref: "#/components/responses/RequestCanceled"
        "504":
          $ref: "#/components/responses/GatewayTimeout"
        "500":
          $ref: "#/components/responses/InternalError"

    post:
      summary: Create link
      description: Creates a short link. If short_name is empty or omitted, it will be autogenerated (unique).
      tags: [links]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateLinkRequest"
      responses:
        "201":
          description: Created
          headers:
            Location:
              description: Created link location
              schema:
                type: string
                example: /api/links/1
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LinkResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "422":
          $ref: "#/components/responses/ValidationError"
        "499":
          $ref: "#/components/responses/RequestCanceled"
        "504":
          $ref: "#/components/responses/GatewayTimeout"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/link_visits:
    get:
      summary: List link visits
      description: |
        Returns all visits when range is not provided.
        When range is provided, returns a page and includes Content-Range.
        Range can be sent either as a `range` query parameter or the `Range` header.
      tags: [link_visits]
      parameters:
        - name: range
          in: query
          description: Range of items, format [start,count].
          required: false
          schema:
            type: string
            example: "[0,10]"
        - name: Range
          in: header
          description: Range of items, format link_visits=start-count.
          required: false
          schema:
            type: string
            example: "link_visits=0-9"
        - name: sort
          in: query
          description: |
            Sort order as JSON [field,ASC|DESC].
            Allowed fields: id, link_id, ip, status, referer, created_at.
            Alias: reffer -> referer.
          required: false
          schema:
            type: string
            example: '["created_at","DESC"]'
      responses:
        "200":
          description: OK
          headers:
            Content-Range:
              description: Range metadata when range is provided.
              schema:
                type: string
                example: "link_visits 0-9/42"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/LinkVisitResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "499":
          $ref: "#/components/responses/RequestCanceled"
        "504":
          $ref: "#/components/responses/GatewayTimeout"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/links/{id}:
    get:
      summary: Get link by ID
      tags: [links]
      parameters:
        - name: id
          in: path
          required: true
          description: Link ID
          schema:
            type: integer
            minimum: 1
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LinkResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "499":
          $ref: "#/components/responses/RequestCanceled"
        "504":
          $ref: "#/components/responses/GatewayTimeout"
        "500":
          $ref: "#/components/responses/InternalError"

    put:
      summary: Update link
      description: |
        Updates existing link.
        - original_url is updated.
        - short_name is updated (optional; autogenerated when omitted).
      tags: [links]
      parameters:
        - name: id
          in: path
          required: true
          description: Link ID
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateLinkRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LinkResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/ValidationError"
        "499":
          $ref: "#/components/responses/RequestCanceled"
        "504":
          $ref: "#/components/responses/GatewayTimeout"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      summary: Delete link
      tags: [links]
      parameters:
        - name: id
          in: path
          required: true
          description: Link ID
          schema:
            type: integer
            minimum: 1
      responses:
        "204":
          description: No Content
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "499":
          $ref: "#/components/responses/RequestCanceled"
        "504":
          $ref: "#/components/responses/GatewayTimeout"
        "500":
          $ref: "#/components/responses/InternalError"

  /r/{code}:
    get:
      summary: Redirect by short name
      description: Redirects to the original URL by short name.
      tags: [redirect]
      parameters:
        - name: code
          in: path
          required: true
          description: Short name
          schema:
            type: string
            minLength: 3
            maxLength: 32
      responses:
        "302":
          description: Found
          headers:
            Location:
              description: Redirect target
              schema:
                type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "499":
          $ref: "#/components/responses/RequestCanceled"
        "504":
          $ref: "#/components/responses/GatewayTimeout"
        "500":
          $ref: "#/components/responses/InternalError"

components:
  schemas:
    CreateLinkRequest:
      type: object
      properties:
        original_url:
          type: string
          example: https://example.com
        short_name:
          type: string
          minLength: 3
          maxLength: 32
          example: abc123
      required: [original_url]

    UpdateLinkRequest:
      type: object
      properties:
        original_url:
          type: string
          example: https://example.com/updated
        short_name:
          type: string
          minLength: 3
          maxLength: 32
          example: abc123
      required: [original_url]

    LinkResponse:
      type: object
      properties:
        id:
          type: integer
          example: 1
        original_url:
          type: string
          example: https://example.com
        short_name:
          type: string
          example: abc123
        short_url:
          type: string
          example: https://example.com/r/abc123
      required: [id, original_url, short_name, short_url]

    LinkVisitResponse:
      type: object
      properties:
        id:
          type: integer
          example: 5
        link_id:
          type: integer
          example: 1
        created_at:
          type: string
          format: date-time
          example: "2025-10-31T13:01:43Z"
        ip:
          type: string
          example: 172.18.0.1
        user_agent:
          type: string
          example: curl/8.5.0
        referer:
          type: string
          example: https://example.com
        status:
          type: integer
          example: 302
      required: [id, link_id, created_at, ip, user_agent, status]

    Problem:
      type: object
      properties:
        type:
          type: string
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        error:
          type: string
      required: [type, title, status]

    ValidationErrors:
      type: object
      properties:
        errors:
          type: object
          additionalProperties:
            type: string
      required: [errors]

  responses:
    BadRequest:
      description: Bad Request (validation error)
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
          examples:
            invalid_range:
              summary: Invalid range
              value:
                type: validation_error
                title: Validation error
                status: 400
                detail: invalid range
            invalid_sort:
              summary: Invalid sort
              value:
                type: validation_error
                title: Validation error
                status: 400
                detail: invalid sort

    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ValidationErrors"
          examples:
            invalid_url:
              summary: Invalid URL
              value:
                errors:
                  original_url: invalid url
            short_name_conflict:
              summary: Short name already in use
              value:
                errors:
                  short_name: short name already in use

    NotFound:
      description: Not Found
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
          example:
            type: about:blank
            title: Not Found
            status: 404
            detail: not found

    Conflict:
      description: Conflict
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
          example:
            type: conflict
            title: Conflict
            status: 409
            detail: short_name already exists

    InternalError:
      description: Internal Server Error
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
          example:
            type: internal_error
            title: Internal Server Error
            status: 500
            detail: internal error

    RequestCanceled:
      description: Request Canceled
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
          example:
            type: client_cancelled
            title: Request Canceled
            status: 499
            detail: request canceled

    GatewayTimeout:
      description: Gateway Timeout
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
          example:
            type: timeout
            title: Gateway Timeout
            status: 504
